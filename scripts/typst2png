#!/bin/bash
#---------------------------------------------------------------------#
# Typst - Soybean44
# This scipt will open up $EDITOR and create and append a typst png to the clipboard
# If you wish to change the template file, just update the path of $template_file or edit the template file at the path specified
#---------------------------------------------------------------------#

# Check if the necessary packages are installed
if ! command -v typst >/dev/null 2>&1 || ! command -v magick >/dev/null 2>&1 || ! command -v xclip >/dev/null 2>&1; then
    echo "Error: Please install the following packages: typst, magick, xclip"
    exit 1
fi

input_file="math"

make_file() {
  template_file="$HOME/dotfiles/scripts/template.typ"
  if [ ! -f $template_file ]; then
      echo "Error: Make sure template file exists"
      exit 1
  fi
  #create math file
  cp "$template_file" "/tmp/$input_file.typ"
}

edit_file() {
  if [[ $EDITOR == "vi" ]] || [[ $EDITOR == "vim" ]] || [[ $EDITOR == "nvim" ]] ; then
    $EDITOR +5 "/tmp/$input_file.typ"
  else
    $EDITOR "/tmp/$input_file.typ"
  fi
}

compile_and_copy() {
  # Generate the PDF file
  cd "/tmp/"
  typst c -f png "$input_file.typ"
  # Copy image to the clipboard
  xclip -selection clipboard -t image/png "$input_file.png"

  echo "The PNG image has been copied to the clipboard."
}

if [[ ! $1 == '-p' ]]; then
  make_file
elif [[ ! $1 == '-r' ]]; then
  edit_file
fi
compile_and_copy
