#!/bin/bash
#---------------------------------------------------------------------#
# Typst - Soybean44
# This scipt will open up $EDITOR and create and append a typst png to the clipboard
# If you wish to change the template file, just update the path of $template_file or edit the template file at the path specified
#---------------------------------------------------------------------#

# Check if the necessary packages are installed
if ! command -v typst >/dev/null 2>&1 || ! command -v magick >/dev/null 2>&1 || ! command -v xclip >/dev/null 2>&1; then
    echo "Error: Please install the following packages: typst, magick, xclip"
    exit 1
fi

cd "/tmp/"
input_file="math"

make_file() {
  template_file="$HOME/dotfiles/scripts/template.typ"
  if [ ! -f $template_file ]; then
      echo "Error: Make sure template file exists"
      exit 1
  fi
  #create math file
  cp "$template_file" "/tmp/$input_file.typ"
}

edit_file() {
  if [[ ! -f "$input_file.typ" ]]; then
    read -p "No temp file exists, create one? [y/N]: " -r confirm
    case $confirm in
      y|Y|yes|Yes|YES) make_file;;
      *) exit 0;;
    esac
  fi
  if [[ $EDITOR == "vi" ]] || [[ $EDITOR == "vim" ]] || [[ $EDITOR == "nvim" ]] ; then
    $EDITOR +5 "/tmp/$input_file.typ"
  else
    $EDITOR "/tmp/$input_file.typ"
  fi
}

compile_and_copy() {
  if [[ ! -f "$input_file.typ" ]]; then
    exit 1
  fi
  # Generate the PDF file
  typst c -f png "$input_file.typ"
  # Copy image to the clipboard
  xclip -selection clipboard -t image/png "$input_file.png"

  echo "The PNG image has been copied to the clipboard."
}

if [[ $1 == '-h' ]] || [[ $1 == '--help' ]]; then
  echo "Useage: typst2png [opts]"
  echo "  -h | --help: Opens this help menu"
  echo "  -p | --previous: Doesn't overwrite the previous tmp file, allowing for edits"
  echo "  -r | --recompile: Recompile's the old file without editing it"
  exit 0
elif [[ $1 == '-p' ]] || [[ $1 == '--previous' ]]; then
  edit_file
  compile_and_copy
elif [[  $1 == '-r' ]] || [[ $1 == '--recompile' ]]; then
  compile_and_copy
else
  make_file
  edit_file
  compile_and_copy
fi

